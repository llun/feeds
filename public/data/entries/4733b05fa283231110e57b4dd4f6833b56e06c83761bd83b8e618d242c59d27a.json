{"title":"iCloud Photos shared album","link":"https://www.llun.me/posts/dev/2022-10-25-iCloud-photos-shared-album","date":1666721558000,"content":"<p>สุดสัปดาห์ที่ผ่านมาลองเปิด Shared Album ใน Apple Photos app แล้วเจอว่ามี Public Website ให้เอา link ไปแจกให้คนอื่นเข้ามาดูรูปได้ ลองกดดูว่ามันดึงรูปมายังไงก็เจอว่า Apple มี API สองอันไว้ดึงรูป เลยได้ idea ว่าจะเอารูปใน iCloud มาใส่ไว้ในเว็บตัวเอง</p>\n<p>API ที่ Apple ใช้มีด้วยกันสองอัน <code>webstream</code> กับ <code>webassetsurls</code></p>\n<h2>Token &amp; API Cluster <a href=\"#token-%26-api-cluster\" target=\"_blank\">#</a></h2>\n<p>ก่อนที่จะเรียก API ได้ต้องรู้สองอย่างคือ token และ API cluster เพราะ URL ของ API มีหน้าตาประมาณนี้ <code>https://p[cluster-id]-sharedstreams.icloud.com/[token]/sharedstreams/webstream</code></p>\n<p>Token ได้มาจาก URL ที่ Apple ให้มาหลังจาก enable public website เช่น <code>https://www.icloud.com/sharedalbum/#B12GfnH8tC0ZuK</code> Token ของ album คือ <code>B12GfnH8tC0ZuK</code></p>\n<figure><a href=\"shared-album-setting.png\" target=\"_blank\"><img src=\"https://www.llun.me/posts/dev/2022-10-25-iCloud-photos-shared-album/shared-album-setting-small.png\" alt /></a><figcaption>Album token จาก Shared Album settings ใน Photos App</figcaption></figure>\n<p>ใน Token นี้มีรายละเอียดของ cluster ซ่อนอยู่โดยแกะจาก token 3 ตัวแรก จาก Token ด้านบนถ้าตัวอักษรแรกเป็น <code>A</code> cluster id คือตัวอักษรที่สองจาก token ด้านบนก็คือ <code>1</code> แล้ว id ใน URL ให้ pad 0 เข้าไปด้านเป็น <code>01</code> แต่ถ้าตัวอักษรแรกเป็น <code>B</code> ต้องแกะเพิ่มนิดหน่อยโดยเอาตัวอักษรที่ 2 กับ 3 มาถอดเช่น token ด้านบน cluster id อยู่ใน <code>12</code> เอามาถอดด้วย Base62 จะได้ cluster ID ออกมาเป็น <code>64</code> (ถ้าเป็นเลขหลักเดียวทำเช่นเดียวกับ <code>A</code> คือ pad 0) URL ที่ใช้เรียก API เต็มๆ ก็จะเป็น <code>https://p64-sharedstreams.icloud.com/B12GfnH8tC0ZuK/sharedstreams/webstream</code></p>\n<h2>webstream API <a href=\"#webstream-api\" target=\"_blank\">#</a></h2>\n<p>Webstream API, <code>sharedstreams/webstream</code> เป็น API ไว้เรียกดูรายละเอียดของ Album ว่ามีรูปอะไรบ้างแต่ละรูปมีความละเอียดเท่าไหร่ หรือวิดีโอมีความละเอียดเท่าไหร่บ้างที่ดึงมาดูได้ เรียกโดยส่ง Post call ไปที่ <code>sharedstreams/webstream</code> API เช่น</p>\n<pre><code>curl 'https://p64-sharedstreams.icloud.com/B12GfnH8tC0ZuK/sharedstreams/webstream' \\\n  --data-raw '{\"streamCtag\":null}' \\\n  --compressed\n</code></pre>\n<p><code>streamCtag</code> เป็น pagination id เวลา album มีรูปเยอะมาก โดยเอาจาก response ที่คืนมาจาก API ที่หน้าตาประมาณนี้</p>\n<pre><code>{\n  \"userLastName\": \"Anegboonlap\",\n  \"streamCtag\": \"FT=-@RU=05cd8aa0-51d9-4671-bfa5-e10cdf277e04@S=16559\",\n  \"itemsReturned\": \"0\",\n  \"locations\": {},\n  \"userFirstName\": \"Maythee\",\n  \"streamName\": \"Sample\",\n  \"photos\": [\n    {\n      \"batchGuid\": \"ACEEC3D1-D3AF-4A21-809B-6E3A043606D8\",\n      \"derivatives\": {\n        \"342\": {\n          \"fileSize\": \"43050\",\n          \"checksum\": \"01f4ef240d7581f208b76b2498789ba759bee245be\",\n          \"width\": \"257\",\n          \"height\": \"342\"\n        },\n        \"2049\": {\n          \"fileSize\": \"985681\",\n          \"checksum\": \"010ca39ab9acf31d14f853ea47a1c110a425f99f27\",\n          \"width\": \"1537\",\n          \"height\": \"2049\"\n        }\n      },\n      \"contributorLastName\": \"Anegboonlap\",\n      \"batchDateCreated\": \"2022-10-25T17:13:49Z\",\n      \"dateCreated\": \"2016-11-03T12:49:49Z\",\n      \"contributorFirstName\": \"Maythee\",\n      \"photoGuid\": \"2C50FDDE-A9D8-4D28-B99B-4265CF2F1D8A\",\n      \"contributorFullName\": \"Maythee Anegboonlap\",\n      \"width\": \"1537\",\n      \"caption\": \"\",\n      \"height\": \"2049\"\n    },\n\n  ],\n  \"items\": {}\n}\n</code></pre>\n<h2>webassetsurls <a href=\"#webassetsurls\" target=\"_blank\">#</a></h2>\n<p>หลังจากได้ <code>photoGuid</code> จาก <code>webstream</code> มาแล้วจะเอา URL รูปไว้สำหรับใส่ img หรือ video source tag ต้องใช้ <code>webassetsurls</code> เช่นเดียวกับ <code>webstream</code> API นี้เป็น POST call เช่นเดียวกัน</p>\n<p>Post body ที่ต้องส่งไปก็คือ <code>photoGuid</code> ที่ได้มาแล้วต้องการ URL รูปกลับมา เช่น</p>\n<pre><code>curl 'https://p64-sharedstreams.icloud.com/B12GfnH8tC0ZuK/sharedstreams/webasseturls' \\\n  --data-raw '{\"photoGuids\":[\"2C50FDDE-A9D8-4D28-B99B-4265CF2F1D8A\"]}' \\\n  --compressed\n</code></pre>\n<p>Response ที่ได้กลับมาจะเป็น map ระหว่าง checksum ของรูปกับ url</p>\n<pre><code>{\n  \"locations\": {\n    \"cvws.icloud-content.com\": {\n      \"scheme\": \"https\",\n      \"hosts\": [\"cvws.icloud-content.com\"]\n    }\n  },\n  \"items\": {\n    \"01f4ef240d7581f208b76b2498789ba759bee245be\": {\n      \"url_expiry\": \"2022-10-25T20:24:35Z\",\n      \"url_location\": \"cvws.icloud-content.com\",\n      \"url_path\": \"/S/AfTvJA11gfIIt2skmHibp1m-4kW-/PB030703.JPG?o=AqAFUL40Bn0KCw60prfUdSWcesRlPbNNjkXjivIBuF1M&amp;v=1&amp;z=https%3A%2F%2Fp64-content.icloud.com%3A443&amp;x=1&amp;a=CAogF8lO2X9BoWWM7YKIEtInjsSSZKRvKSXXkIpAFoflsrwSZRC_5rKBwTAYv_3FhsEwIgEAUgS-4kW-aiWzPwvbIdF-8fxta-bfw_DwKbBU-F0LVEwU2_NU8wE9husrBWsmciVQwi_Si9bGqbIi9Y_EupbNdAvIPlFWslPObm19Oh120GcygDeT&amp;e=1666729475&amp;r=7dc2183b-3f0f-47ef-a03a-ab4c76d397a6-13&amp;s=64dLJRQ4LomOTK0BykgYZ7QyUf4\"\n    }\n  }\n}\n</code></pre>\n<p>เวลาเอาไปใช้คือเอา <code>url_locations</code> รวมกับ <code>scheme</code> ด้านบน และ <code>url_path</code> ก็จะได้ url รูปภาพที่เอาไปใส่ใน tag ได้</p>\n<h2>Limitation <a href=\"#limitation\" target=\"_blank\">#</a></h2>\n<p>ข้อจำกัดของ Shared Album Apple มีอย่างเดียวคือขนาดรูปหรือ Video ที่ไม่ได้ออกมาตามที่เก็บไว้ใน iCloud <a href=\"https://support.apple.com/en-us/HT202786\" target=\"_blank\">แต่เป็นรูปหรือ video ที่ย่อมาแล้ว</a></p>\n<p>ถ้าเป็นรูปก็จะถูกย่อลงมาเหลือ 2048px ส่วน video ถ้าถ่ายมามากกว่า 720p ก็จะเหลือ 720p ส่วนตัวไม่มีปัญหาอะไรกับข้อจำกัดนี้ แต่ถ้าเทียบกับ Google Photos แล้วข้อจำกัดก็เยอะกว่ามาก แถมถ้าเทียบกับ Google ที่มีรายละเอียดของ API ชัดเจนว่าให้เล่นยังไง แทนที่จะต้องแกะเอาเอง ถ้าไม่ได้ใช้มือถือ Google แล้วอยากเอาภาพมาแปะในเว็บก็คงไม่ย้ายมา iCloud</p>\n<h2>Gallery <a href=\"#gallery\" target=\"_blank\">#</a></h2>\n<p>ตอนนี้มีอยู่สองหน้าที่ตอนนี้แปะภาพจาก iCloud ไว้คือหน้าที่เก็บรายละเอียดปั่นจักรยานไว้ทั้ง <a href=\"https://www.llun.me/tags/ride/netherlands/\" target=\"_blank\">Netherlands</a> และ <a href=\"https://www.llun.me/tags/ride/singapore/\" target=\"_blank\">Singapore</a> ยังทำไม่เสร็จดีเท่าไหร่ แต่ถ้าอยากดูตัวอย่างก็ลองไปดูได้ที่ URL ด้านบน ส่วนตัวอย่าง code แบบ typescript อยู่นี่ <a href=\"https://github.com/llun/blog/blob/master/libs/apple/webstream.ts\" target=\"_blank\">https://github.com/llun/blog/blob/master/libs/apple/webstream.ts</a></p>\n","author":"Maythee Anegboonlap","siteTitle":"@llun story","siteHash":"e492a4c5a091b6624e5872d8d003bc73eb1166cc8f88db58c44e1f8dfb9c7252","entryHash":"4733b05fa283231110e57b4dd4f6833b56e06c83761bd83b8e618d242c59d27a","category":"Me"}