{"title":"q.js and Mocha","link":"https://www.llun.me/posts/dev/2013-11-10-qjs-mocha/","date":1384041600000,"content":"\n      \n        <p>ปัญหาที่น่าปวดหัวอย่างหนึ่งเวลาเขียน spec คู่กับ <a href=\"https://github.com/kriskowal/q\" target=\"_blank\" rel=\"noopener\">q.js</a> คือ q.js จัดการ exception ให้เวลา expect แล้ว fail, exception ที่ throw จาก spec เลยไม่ถูกส่งออกมาถึง spec กลายเป็นว่า spec นั้นผ่านเพราะไม่มี error อะไร หรือถ้าเป็น async เวลาเรียก done ใน q ก็เหมือนมีตัวแปรชื่อเดียวกันอีก กลายเป็นว่า done ของ spec ไม่ถูกเรียกไปเรียกของ q แทน ตัวอย่าง spec ง่ายๆ เช่น</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">authenticate</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />  q<span class=\"token punctuation\">.</span><span class=\"token function\">nfcall</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">.</span>authenticate<span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>username<span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">)</span><br />    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />      res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><br />    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br />    <span class=\"token punctuation\">.</span><span class=\"token function\">fail</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />      res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><br />    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br /><span class=\"token punctuation\">}</span></code></pre>\n<p>เวลาเขียน spec อย่างง่ายๆ ที่คาดหวังคือ</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#authenticate'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should return error when password is wrong'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />    <span class=\"token function\">authenticate</span><span class=\"token punctuation\">(</span><br />      <span class=\"token punctuation\">{</span> username<span class=\"token operator\">:</span> <span class=\"token string\">'username'</span><span class=\"token punctuation\">,</span> password<span class=\"token operator\">:</span> <span class=\"token string\">'wrongpassword'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br />      <span class=\"token punctuation\">{</span><br />        <span class=\"token function-variable function\">json</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">status<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />          <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">.</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><br />          <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Wrong password'</span><span class=\"token punctuation\">)</span><br />          <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br />        <span class=\"token punctuation\">}</span><br />      <span class=\"token punctuation\">}</span><br />    <span class=\"token punctuation\">)</span><br />  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br /><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre>\n<p>ซึ่งควรจะรันแบบผ่านไปได้ด้วยดี ถ้ามี error ก็แสดงออกมาแต่หลังจากรัน mocha จะ error เพราะ timeout (done ไม่ถูกเรียก) ทางแก้ง่ายสุดคือใช้ flag เข้าช่วยแล้วให้ interval คอยตรวจว่า flag เปลี่ยนไปหรือยังได้ออกมาเป็น specs version 2 (ใน test_it หรือ jasmine ใช้ waitFor ได้)</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#authenticate'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should return error when password is wrong'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />    <span class=\"token keyword\">var</span> flag <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><br />    <span class=\"token keyword\">var</span> output <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><br /><br />    <span class=\"token function\">authenticate</span><span class=\"token punctuation\">(</span><br />      <span class=\"token punctuation\">{</span> username<span class=\"token operator\">:</span> <span class=\"token string\">'username'</span><span class=\"token punctuation\">,</span> password<span class=\"token operator\">:</span> <span class=\"token string\">'wrongpassword'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br />      <span class=\"token punctuation\">{</span><br />        <span class=\"token function-variable function\">json</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">status<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />          flag <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><br />          output<span class=\"token punctuation\">.</span>status <span class=\"token operator\">=</span> status<br />          output<span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> data<br />        <span class=\"token punctuation\">}</span><br />      <span class=\"token punctuation\">}</span><br />    <span class=\"token punctuation\">)</span><br /><br />    <span class=\"token keyword\">var</span> interval <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>flag<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><br /><br />      <span class=\"token function\">clearInterval</span><span class=\"token punctuation\">(</span>interval<span class=\"token punctuation\">)</span><br />      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">.</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><br />      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Wrong password'</span><span class=\"token punctuation\">)</span><br />      <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br />    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><br />  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br /><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre>\n<p>ซึ่งหน้าตายาวเหยียดและดูไม่น่าเขียนเท่าไหร่ เลยหาทางกำจัด flag กับ setInterval ก่อนออกมาเป็น version 3</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#authenticate'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should return error when password is wrong'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />    <span class=\"token keyword\">var</span> deferred <span class=\"token operator\">=</span> q<span class=\"token punctuation\">.</span><span class=\"token function\">defer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br />    <span class=\"token keyword\">var</span> output <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><br /><br />    deferred<span class=\"token punctuation\">.</span>promise<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">.</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><br />      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Wrong password'</span><span class=\"token punctuation\">)</span><br />      <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br />    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br /><br />    <span class=\"token function\">authenticate</span><span class=\"token punctuation\">(</span><br />      <span class=\"token punctuation\">{</span> username<span class=\"token operator\">:</span> <span class=\"token string\">'username'</span><span class=\"token punctuation\">,</span> password<span class=\"token operator\">:</span> <span class=\"token string\">'wrongpassword'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br />      <span class=\"token punctuation\">{</span><br />        <span class=\"token function-variable function\">json</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">status<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />          output<span class=\"token punctuation\">.</span>status <span class=\"token operator\">=</span> status<br />          output<span class=\"token punctuation\">.</span>data <span class=\"token operator\">=</span> data<br />          deferred<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br />        <span class=\"token punctuation\">}</span><br />      <span class=\"token punctuation\">}</span><br />    <span class=\"token punctuation\">)</span><br />  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br /><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre>\n<p>สิ่งที่ยังกวนใจอยู่คือ output ที่มันควรส่งเข้าไปให้ test ตรงๆ ได้ไม่ต้องมาสร้าง variable รับอีกเลยใช้ spread ช่วย</p>\n<pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'#authenticate'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />  <span class=\"token function\">it</span><span class=\"token punctuation\">(</span><span class=\"token string\">'should return error when password is wrong'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">done</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />    <span class=\"token keyword\">var</span> deferred <span class=\"token operator\">=</span> q<span class=\"token punctuation\">.</span><span class=\"token function\">defer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br /><br />    deferred<span class=\"token punctuation\">.</span>promise<span class=\"token punctuation\">.</span><span class=\"token function\">spread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">status<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><br />      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>to<span class=\"token punctuation\">.</span><span class=\"token function\">equal</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Wrong password'</span><span class=\"token punctuation\">)</span><br />      <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br />    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br /><br />    <span class=\"token function\">authenticate</span><span class=\"token punctuation\">(</span><br />      <span class=\"token punctuation\">{</span> username<span class=\"token operator\">:</span> <span class=\"token string\">'username'</span><span class=\"token punctuation\">,</span> password<span class=\"token operator\">:</span> <span class=\"token string\">'wrongpassword'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span><br />      <span class=\"token punctuation\">{</span><br />        <span class=\"token function-variable function\">json</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">status<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br />          deferred<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>status<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><br />        <span class=\"token punctuation\">}</span><br />      <span class=\"token punctuation\">}</span><br />    <span class=\"token punctuation\">)</span><br />  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><br /><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre>\n<p>นี่แหละที่ต้องการมี code เพิ่มนิดหน่อยเกือบจะเท่าแบบแรกสุดแถมดูดีอีกต่างหาก ไม่มีตัวแปรอื่นมากวนเท่าไหร่ เขียนมานี่ตอนลองมั่วอยู่นานกว่าจะได้ แต่ก่อนใช้ mocha-as-promise ช่วยแต่พบว่ามันดันให้ผ่านใน test ที่ควรจะ fail เลยเลิกใช้เลย</p>\n\n        <p>\n          <a href=\"mailto:comment@llun.me?subject=Common on post https://www.llun.me/posts/dev/2013-11-10-qjs-mocha/\">Send a comment</a>\n        </p>\n      \n    ","author":"","siteTitle":"@llun story","siteHash":"e492a4c5a091b6624e5872d8d003bc73eb1166cc8f88db58c44e1f8dfb9c7252","entryHash":"07d59c702130635d8c2e3ac6299712d2a548d7a0da1219df747cc10b9b5b455a","category":"Me"}