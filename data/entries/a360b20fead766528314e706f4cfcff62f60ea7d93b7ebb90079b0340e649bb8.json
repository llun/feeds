{"title":"OpenVPN + DD-WRT","link":"https://www.llun.me/posts/dev/2014-06-22-openvpn-dd-wrt/","date":1403395200000,"content":"\n      \n        <p>เนื่องด้วย Internet ที่นี่ไม่ได้ดีอย่างที่คิด ปัญหาคล้ายๆ กับ ISP ในไทยคือมันผ่าน Proxy! เวลาจะดาวโหลดอะไรบางอย่างเช่น Xcode หรือ OSX จาก Apple Developer ก็มักจะเจออาการอะไรแปลกๆ เสมอจนไม่นานมานี้ถอย Router มาใหม่และมัน Supported DD-WRT มาตั้งแต่โรงงาน (<a href=\"http://www.buffalo-technology.com/en/products/network-devices/300mbps-wireless-n/routers/airstation-trade-nfiniti-trade-wireless-n-high-power-router/\">Buffalo WZR-HP-G300NH2</a>) หลังจาก update firmware ทุกอย่างเสร็จก็ลองกับ <a href=\"http://www.cyberghostvpn.com/\">VPN</a> ที่สมัครไว้อยู่แล้วก็ใช้ได้ดีจนพบว่า ด้วยสาเหตุอะไรบางอย่าง <a href=\"http://www.cyberghostvpn.com/\">Cyberghost VPN</a> ชอบตัด Connection ทิ้งเมื่อต่อไปนานๆ หรือ unresponse ไปเสียดื้อๆ โดยที่ router ก็ไม่ reconnect ต่อให้ด้วย วันนี้คิดว่าว่างๆ เลยหาทางตั้ง OpenVPN server เองซะเลย ยังไงก็มี server ให้เล่นเยอะอยู่แล้ว</p>\n<h3 id=\"%E0%B8%9D%E0%B8%B1%E0%B9%88%E0%B8%87-server\">ฝั่ง Server <a class=\"direct-link\" href=\"https://www.llun.me/posts/dev/2014-06-22-openvpn-dd-wrt/#%E0%B8%9D%E0%B8%B1%E0%B9%88%E0%B8%87-server\">#</a></h3>\n<p>Server ที่ใช้เป็น Debian7 <s>แต่ถ้าใช้ CentOS ก็คิดว่าไม่ต่างกันมาก ไว้ลองกับ Server ที่ไทยแล้วจะมา Update เพิ่ม</s> (เพิ่มเติมส่วน CentOS ไว้แล้วด้านล่าง)</p>\n<p>เริ่มจากติด OpenVPN package ด้วย apt-get</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">apt-get</span> <span class=\"token function\">install</span> openvpn</code></pre>\n<p>ติดเสร็จก็ generate key ของฝั่ง server ให้พร้อม</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">cp</span> -r /usr/share/doc/openvpn/examples/easy-rsa /etc/openvpn<br /><span class=\"token builtin class-name\">cd</span> /etc/openvpn/easy-rsa/2.0<br /><span class=\"token builtin class-name\">source</span> vars<br />./clean-all<br />./build-ca<br />./build-key-server server<br />./build-dh</code></pre>\n<p>บรรทัดแรกเริ่มจาก copy เครื่องมือสำหรับสร้าง key/cert ต่างๆที่ openvpn เตรียมไว้ให้แล้วมาไว้ที่เดียวกับ config ของ openvpn จะได้ใช้สะดวกในอนาคต จากนั้นก็ล้างแล้วสร้าง key/cert ต่างๆของฝั่ง server</p>\n<p>ได้ไฟล์ key มาครบแล้วก็ copy กลับมาที่ directory config ของ openvpn</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">cp</span> /etc/openvpn/easy-rsa/2.0/keys/ca.crt /etc/openvpn<br /><span class=\"token function\">cp</span> /etc/openvpn/easy-rsa/2.0/keys/ca.key /etc/openvpn<br /><span class=\"token function\">cp</span> /etc/openvpn/easy-rsa/2.0/keys/server.crt /etc/openvpn<br /><span class=\"token function\">cp</span> /etc/openvpn/easy-rsa/2.0/keys/server.key /etc/openvpn<br /><span class=\"token function\">cp</span> /etc/openvpn/easy-rsa/2.0/keys/dh1024.pem /etc/openvpn</code></pre>\n<p>จากนั้นก็สร้าง client key/cert ต่อ</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> /etc/openvpn/easy-rsa/2.0<br />./build-key client</code></pre>\n<p>client จะเป็นชื่ออื่นก็ได้เช่น ชื่อเครื่องที่จะต่อเข้ามา สร้างเสร็จก็ดาวโหลด <code>client.crt</code> <code>client.key</code> <code>ca.crt</code> ลงมาที่ client เตรียมเอาไว้ต่อกับ server<br />\nหลังจาก cert ทุกอย่างพร้อมแล้วก็สร้าง openvpn config ขึ้นมา จะ copy จาก example ก็ได้แต่ด้านล่างนี้คือไฟล์ config ปัจจุบันที่ใช้ สร้างไว้ใน <code>/etc/openvpn/server.conf</code></p>\n<pre><code>port 1194\nproto udp\n\ndev tun\n\nca ca.crt\ncert server.crt\nkey server.key\n;openvpn --genkey --secret ta.key //optional\ntls-auth ta.key 0\n\ndh dh1024.pem\nserver 192.168.50.0 255.255.255.0\nifconfig-pool-persist ipp.txt\n\npush &quot;redirect-gateway def1 bypass-dhcp&quot;\npush &quot;dhcp-option DNS 8.8.8.8&quot;\npush &quot;dhcp-option DNS 8.8.4.4&quot;\n\nkeepalive 10 120\ncipher AES-256-CBC\nauth SHA1\ncomp-lzo\n\npersist-key\npersist-tun\n\nstatus /var/log/openvpn-status.log\nlog-append  /var/log/openvpn.log\n\nverb 4\nmute 10\n</code></pre>\n<p>จากนั้นก็ restart openvpn <code>/etc/init.d/openvpn restart</code> เป็นอันเรียบร้อย</p>\n<p>แต่ แต่ แต่ แค่นี้ทำให้ต่อเข้ามาได้แต่ออกไปไหนไม่ได้ ต้องทำเพิ่มอีกนิดหน่อยด้วยการบอกให้ iptables สร้าง route ให้ด้วย</p>\n<p>เริ่มจากอนุญาติให้ forward traffic ได้ก่อน</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># แบบชั่วคราว</span><br /><span class=\"token builtin class-name\">echo</span> <span class=\"token number\">1</span> <span class=\"token operator\">></span> /proc/sys/net/ipv4/ip_forward<br /><br /><span class=\"token comment\"># แบบถาวร</span><br /><span class=\"token function\">vim</span> /etc/sysctl.conf<br /><span class=\"token comment\"># uncomment net.ipv4.ip_forward = 1</span></code></pre>\n<p>จากนั้นก็เพิ่ม route ตามนี้ (ถ้า ip ต่างจากด้านบนก็แก้ตามที่เปลี่ยน)</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">iptables -A INPUT -p udp --dport <span class=\"token number\">1194</span> -j ACCEPT<br />iptables -A INPUT -i tun+ -j ACCEPT<br />iptables -A FORWARD -i tun+ -j ACCEPT<br />iptables -t nat -A POSTROUTING -s <span class=\"token number\">192.168</span>.0.0/16 -o eth0 -j MASQUERADE<br />iptables-save <span class=\"token operator\">></span> /etc/network/iptables</code></pre>\n<p>เรียบร้อย</p>\n<p><strong>เพิ่มเติมสำหรับ CentOS</strong></p>\n<p>วิธีการก็คล้ายๆ กับ Debian เริ่มจากติด OpenVPN จาก yum</p>\n<pre class=\"language-bash\"><code class=\"language-bash\">yum <span class=\"token function\">install</span> openvpn</code></pre>\n<p>แต่ที่ต่างออกไปคือใน CentOS ไม่มี easy-vpn แถมมาให้ด้วยต้องดาวโหลดมาเพิ่มเอง</p>\n<pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone https://github.com/OpenVPN/easy-rsa.git<br /><span class=\"token builtin class-name\">cd</span> easy-rsa<br /><span class=\"token function\">git</span> checkout v2.2.1<br /><span class=\"token function\">mkdir</span> -p /etc/openvpn/easy-rsa<br /><span class=\"token function\">cp</span> -r easy-rsa/2.0 /etc/openvpn/easy-rsa</code></pre>\n<p>ที่เหลือก็ทำแบบเดียวกับ Debian ทุกประการ</p>\n<h3 id=\"%E0%B8%9D%E0%B8%B1%E0%B9%88%E0%B8%87-client-(dd-wrt)\">ฝั่ง Client (DD-WRT) <a class=\"direct-link\" href=\"https://www.llun.me/posts/dev/2014-06-22-openvpn-dd-wrt/#%E0%B8%9D%E0%B8%B1%E0%B9%88%E0%B8%87-client-(dd-wrt)\">#</a></h3>\n<p>OpenVPN Client ใน DD-WRT อยู่ใต้ tab Services &gt; VPN เมนูล่างสุด (ไม่แน่ใจว่าต่างไปในแต่ firmware หรือไม่แต่ที่ใช้อยู่ อยู่ใต้นี้) พอเลือก Enable ปุ๊บจะมี Option มาให้เลือกยุบยับเลยแต่ก็ใส่ไปตามนี้</p>\n<ul>\n<li>\n<p><strong>Server IP/Name</strong> ก็ตามชื่อจะเป็น IP หรือ Domain name ก็ว่าไป</p>\n</li>\n<li>\n<p><strong>Port</strong> ถ้าใช้ config ด้านบนก็ไม่ต้องใส่อะไร</p>\n</li>\n<li>\n<p><strong>Tunnel Device</strong> tun</p>\n</li>\n<li>\n<p><strong>Tunnel Protocol</strong> udp (ถ้า config ด้านบนเป็น tcp ก็แก้เป็น tcp ซะ)</p>\n</li>\n<li>\n<p><strong>Encryption Cipher</strong> AES-256 CBC</p>\n</li>\n<li>\n<p><strong>Hash Algorithm</strong> SHA1</p>\n</li>\n<li>\n<p><strong>Advanced Options</strong> Enable</p>\n</li>\n<li>\n<p><strong>LZO Compression</strong> Adaptive</p>\n</li>\n<li>\n<p><strong>Additional Config</strong></p>\n<p>resolv-retry infinite<br />\nnobind<br />\npersist-key<br />\npersist-tun<br />\nping 10<br />\nping-exit 120<br />\nping-timer-rem<br />\nverb 4<br />\ncomp-lzo</p>\n</li>\n<li>\n<p><strong>CA Cert</strong> อันนี้ <code>cat ca.crt</code> ที่ได้จากด้านบนมาแล้วเอามาใส่</p>\n</li>\n<li>\n<p><strong>Public Client Cert</strong> <code>cat client.crt</code></p>\n</li>\n<li>\n<p><strong>Private Client Key</strong> <code>cat client.key</code></p>\n</li>\n</ul>\n<p>จากนั้น Apply Settings แล้วก็รอซักแป๊บ เนทที่บ้านท่านก็จะต่อ VPN อัตโนมัติ</p>\n<p>ถ้าอยากให้ต่อได้มากกว่า 1 เครื่องก็ generate client key มาเพิ่ม <code>/etc/openvpn/easy-rsa/2.0/build-key another-client</code> ก็เรียบร้อย</p>\n<h3 id=\"%E0%B8%AD%E0%B9%89%E0%B8%B2%E0%B8%87%E0%B8%AD%E0%B8%B4%E0%B8%87\">อ้างอิง <a class=\"direct-link\" href=\"https://www.llun.me/posts/dev/2014-06-22-openvpn-dd-wrt/#%E0%B8%AD%E0%B9%89%E0%B8%B2%E0%B8%87%E0%B8%AD%E0%B8%B4%E0%B8%87\">#</a></h3>\n<ul>\n<li><a href=\"https://wiki.debian.org/OpenVPN\" target=\"_blank\" rel=\"noopener\">Debian OpenVPN guide</a></li>\n<li><a href=\"http://code.mixpanel.com/2010/09/08/openvpn-in-the-rackspace-cloud/\">Mixpanel Engineer: Secure your codebase: OpenVPN in the (Rackspace) Cloud</a></li>\n<li><a href=\"https://www.digitalocean.com/community/tutorials/how-to-setup-and-configure-an-openvpn-server-on-debian-6\" target=\"_blank\" rel=\"noopener\">Digital Ocean: How to Setup and Configure an OpenVPN Server on Debian 6</a></li>\n<li><a href=\"https://support.cyberghostvpn.com/index.php?/Knowledgebase/Article/View/667/184/cyberghost-with-openvpn-on-flashed-dd-wrt-routers\" target=\"_blank\" rel=\"noopener\">CyberGhost with OpenVPN on flashed DD-WRT routers</a></li>\n<li><a href=\"https://forums.openvpn.net/topic10290.html\" target=\"_blank\" rel=\"noopener\">Install help needed on centOS 6</a></li>\n<li><a href=\"https://github.com/OpenVPN/easy-rsa\" target=\"_blank\" rel=\"noopener\">Easy-VPN github</a></li>\n</ul>\n\n        <p>\n          <a href=\"mailto:comment@llun.me?subject=Common on post https://www.llun.me/posts/dev/2014-06-22-openvpn-dd-wrt/\">Send a comment</a>\n        </p>\n      \n    ","author":"","siteTitle":"@llun story","siteHash":"e492a4c5a091b6624e5872d8d003bc73eb1166cc8f88db58c44e1f8dfb9c7252","entryHash":"a360b20fead766528314e706f4cfcff62f60ea7d93b7ebb90079b0340e649bb8","category":"Me"}