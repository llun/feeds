{"title":"Memoize and memory leak","link":"https://www.llun.me/posts/dev/2024-03-03-memoize-and-memory-leak","date":1709461533000,"content":"<p>Last month I got one of interesting problem, the NextJS service has a memory leak. Profiling it suggests that i18next translation that creates by <code>cloneInstance</code> doesn’t get remove when the request is done and turn out it’s because the <code>memoize</code> function that we use to store the response of one API causing this</p>\n<pre><code>const apiResponse = memoize((apiParam: number) =&gt; {\n  const data = await fetch(api, { body: JSON.stringify({ apiParam }) })\n\treturn `${t('key')}-${data.value}`\n})\n</code></pre>\n<p>The function looks simple and the memoize was making sense to me in the beginning however, because the <code>apiParams</code> can be anything, and the <code>t</code> function which store all the translations is inside this causing it to never release and get collect by garbage collector.</p>\n<p>This was working when we use it in the browser before because the lifetime of the code is short lived compared to the server side that we use in Next.JS. In the end, we remove the memoize part and making sure this in the practice that when we use memoize, making sure that parameter of the function has a limit boundary and this solve the problem.</p>\n","author":"Maythee Anegboonlap","siteTitle":"@llun story","siteHash":"e492a4c5a091b6624e5872d8d003bc73eb1166cc8f88db58c44e1f8dfb9c7252","entryHash":"1cddd38b22951f8556eb39a485a5b52a01695de245f831c0b1ed13cdf0624f2d","category":"Category1"}