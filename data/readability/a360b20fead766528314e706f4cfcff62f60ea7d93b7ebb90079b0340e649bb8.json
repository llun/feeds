{"title":"OpenVPN + DD-WRT","link":"https://www.llun.me/posts/dev/2014-06-22-openvpn-dd-wrt/","date":1403395200000,"content":"<div id=\"readability-page-1\" class=\"page\"><div><p>เนื่องด้วย Internet ที่นี่ไม่ได้ดีอย่างที่คิด ปัญหาคล้ายๆ กับ ISP ในไทยคือมันผ่าน Proxy! เวลาจะดาวโหลดอะไรบางอย่างเช่น Xcode หรือ OSX จาก Apple Developer ก็มักจะเจออาการอะไรแปลกๆ เสมอจนไม่นานมานี้ถอย Router มาใหม่และมัน Supported DD-WRT มาตั้งแต่โรงงาน (<a href=\"http://www.buffalo-technology.com/en/products/network-devices/300mbps-wireless-n/routers/airstation-trade-nfiniti-trade-wireless-n-high-power-router/\">Buffalo WZR-HP-G300NH2</a>) หลังจาก update firmware ทุกอย่างเสร็จก็ลองกับ <a href=\"http://www.cyberghostvpn.com/\">VPN</a> ที่สมัครไว้อยู่แล้วก็ใช้ได้ดีจนพบว่า ด้วยสาเหตุอะไรบางอย่าง <a href=\"http://www.cyberghostvpn.com/\">Cyberghost VPN</a> ชอบตัด Connection ทิ้งเมื่อต่อไปนานๆ หรือ unresponse ไปเสียดื้อๆ โดยที่ router ก็ไม่ reconnect ต่อให้ด้วย วันนี้คิดว่าว่างๆ เลยหาทางตั้ง OpenVPN server เองซะเลย ยังไงก็มี server ให้เล่นเยอะอยู่แล้ว</p><h3 id=\"%E0%B8%9D%E0%B8%B1%E0%B9%88%E0%B8%87-server\">ฝั่ง Server <a href=\"#%E0%B8%9D%E0%B8%B1%E0%B9%88%E0%B8%87-server\">#</a></h3><p>Server ที่ใช้เป็น Debian7 <s>แต่ถ้าใช้ CentOS ก็คิดว่าไม่ต่างกันมาก ไว้ลองกับ Server ที่ไทยแล้วจะมา Update เพิ่ม</s> (เพิ่มเติมส่วน CentOS ไว้แล้วด้านล่าง)</p><p>เริ่มจากติด OpenVPN package ด้วย apt-get</p><pre><code><span>apt-get</span> <span>install</span> openvpn</code></pre><p>ติดเสร็จก็ generate key ของฝั่ง server ให้พร้อม</p><pre><code><span>cp</span> -r /usr/share/doc/openvpn/examples/easy-rsa /etc/openvpn<br><span>cd</span> /etc/openvpn/easy-rsa/2.0<br><span>source</span> vars<br>./clean-all<br>./build-ca<br>./build-key-server server<br>./build-dh</code></pre><p>บรรทัดแรกเริ่มจาก copy เครื่องมือสำหรับสร้าง key/cert ต่างๆที่ openvpn เตรียมไว้ให้แล้วมาไว้ที่เดียวกับ config ของ openvpn จะได้ใช้สะดวกในอนาคต จากนั้นก็ล้างแล้วสร้าง key/cert ต่างๆของฝั่ง server</p><p>ได้ไฟล์ key มาครบแล้วก็ copy กลับมาที่ directory config ของ openvpn</p><pre><code><span>cp</span> /etc/openvpn/easy-rsa/2.0/keys/ca.crt /etc/openvpn<br><span>cp</span> /etc/openvpn/easy-rsa/2.0/keys/ca.key /etc/openvpn<br><span>cp</span> /etc/openvpn/easy-rsa/2.0/keys/server.crt /etc/openvpn<br><span>cp</span> /etc/openvpn/easy-rsa/2.0/keys/server.key /etc/openvpn<br><span>cp</span> /etc/openvpn/easy-rsa/2.0/keys/dh1024.pem /etc/openvpn</code></pre><p>จากนั้นก็สร้าง client key/cert ต่อ</p><pre><code><span>cd</span> /etc/openvpn/easy-rsa/2.0<br>./build-key client</code></pre><p>client จะเป็นชื่ออื่นก็ได้เช่น ชื่อเครื่องที่จะต่อเข้ามา สร้างเสร็จก็ดาวโหลด <code>client.crt</code> <code>client.key</code> <code>ca.crt</code> ลงมาที่ client เตรียมเอาไว้ต่อกับ server<br>หลังจาก cert ทุกอย่างพร้อมแล้วก็สร้าง openvpn config ขึ้นมา จะ copy จาก example ก็ได้แต่ด้านล่างนี้คือไฟล์ config ปัจจุบันที่ใช้ สร้างไว้ใน <code>/etc/openvpn/server.conf</code></p><pre><code>port 1194\nproto udp\n\ndev tun\n\nca ca.crt\ncert server.crt\nkey server.key\n;openvpn --genkey --secret ta.key //optional\ntls-auth ta.key 0\n\ndh dh1024.pem\nserver 192.168.50.0 255.255.255.0\nifconfig-pool-persist ipp.txt\n\npush \"redirect-gateway def1 bypass-dhcp\"\npush \"dhcp-option DNS 8.8.8.8\"\npush \"dhcp-option DNS 8.8.4.4\"\n\nkeepalive 10 120\ncipher AES-256-CBC\nauth SHA1\ncomp-lzo\n\npersist-key\npersist-tun\n\nstatus /var/log/openvpn-status.log\nlog-append  /var/log/openvpn.log\n\nverb 4\nmute 10\n</code></pre><p>จากนั้นก็ restart openvpn <code>/etc/init.d/openvpn restart</code> เป็นอันเรียบร้อย</p><p>แต่ แต่ แต่ แค่นี้ทำให้ต่อเข้ามาได้แต่ออกไปไหนไม่ได้ ต้องทำเพิ่มอีกนิดหน่อยด้วยการบอกให้ iptables สร้าง route ให้ด้วย</p><p>เริ่มจากอนุญาติให้ forward traffic ได้ก่อน</p><pre><code><span># แบบชั่วคราว</span><br><span>echo</span> <span>1</span> <span>&gt;</span> /proc/sys/net/ipv4/ip_forward<p><span># แบบถาวร</span><br><span>vim</span> /etc/sysctl.conf<br><span># uncomment net.ipv4.ip_forward = 1</span></p></code></pre><p>จากนั้นก็เพิ่ม route ตามนี้ (ถ้า ip ต่างจากด้านบนก็แก้ตามที่เปลี่ยน)</p><pre><code>iptables -A INPUT -p udp --dport <span>1194</span> -j ACCEPT<br>iptables -A INPUT -i tun+ -j ACCEPT<br>iptables -A FORWARD -i tun+ -j ACCEPT<br>iptables -t nat -A POSTROUTING -s <span>192.168</span>.0.0/16 -o eth0 -j MASQUERADE<br>iptables-save <span>&gt;</span> /etc/network/iptables</code></pre><p>เรียบร้อย</p><p><strong>เพิ่มเติมสำหรับ CentOS</strong></p><p>วิธีการก็คล้ายๆ กับ Debian เริ่มจากติด OpenVPN จาก yum</p><pre><code>yum <span>install</span> openvpn</code></pre><p>แต่ที่ต่างออกไปคือใน CentOS ไม่มี easy-vpn แถมมาให้ด้วยต้องดาวโหลดมาเพิ่มเอง</p><pre><code><span>git</span> clone https://github.com/OpenVPN/easy-rsa.git<br><span>cd</span> easy-rsa<br><span>git</span> checkout v2.2.1<br><span>mkdir</span> -p /etc/openvpn/easy-rsa<br><span>cp</span> -r easy-rsa/2.0 /etc/openvpn/easy-rsa</code></pre><p>ที่เหลือก็ทำแบบเดียวกับ Debian ทุกประการ</p><h3 id=\"%E0%B8%9D%E0%B8%B1%E0%B9%88%E0%B8%87-client-(dd-wrt)\">ฝั่ง Client (DD-WRT) <a href=\"#%E0%B8%9D%E0%B8%B1%E0%B9%88%E0%B8%87-client-(dd-wrt)\">#</a></h3><p>OpenVPN Client ใน DD-WRT อยู่ใต้ tab Services &gt; VPN เมนูล่างสุด (ไม่แน่ใจว่าต่างไปในแต่ firmware หรือไม่แต่ที่ใช้อยู่ อยู่ใต้นี้) พอเลือก Enable ปุ๊บจะมี Option มาให้เลือกยุบยับเลยแต่ก็ใส่ไปตามนี้</p><ul><li><p><strong>Server IP/Name</strong> ก็ตามชื่อจะเป็น IP หรือ Domain name ก็ว่าไป</p></li><li><p><strong>Port</strong> ถ้าใช้ config ด้านบนก็ไม่ต้องใส่อะไร</p></li><li><p><strong>Tunnel Device</strong> tun</p></li><li><p><strong>Tunnel Protocol</strong> udp (ถ้า config ด้านบนเป็น tcp ก็แก้เป็น tcp ซะ)</p></li><li><p><strong>Encryption Cipher</strong> AES-256 CBC</p></li><li><p><strong>Hash Algorithm</strong> SHA1</p></li><li><p><strong>Advanced Options</strong> Enable</p></li><li><p><strong>LZO Compression</strong> Adaptive</p></li><li><p><strong>Additional Config</strong></p><p>resolv-retry infinite<br>nobind<br>persist-key<br>persist-tun<br>ping 10<br>ping-exit 120<br>ping-timer-rem<br>verb 4<br>comp-lzo</p></li><li><p><strong>CA Cert</strong> อันนี้ <code>cat ca.crt</code> ที่ได้จากด้านบนมาแล้วเอามาใส่</p></li><li><p><strong>Public Client Cert</strong> <code>cat client.crt</code></p></li><li><p><strong>Private Client Key</strong> <code>cat client.key</code></p></li></ul><p>จากนั้น Apply Settings แล้วก็รอซักแป๊บ เนทที่บ้านท่านก็จะต่อ VPN อัตโนมัติ</p><p>ถ้าอยากให้ต่อได้มากกว่า 1 เครื่องก็ generate client key มาเพิ่ม <code>/etc/openvpn/easy-rsa/2.0/build-key another-client</code> ก็เรียบร้อย</p><h3 id=\"%E0%B8%AD%E0%B9%89%E0%B8%B2%E0%B8%87%E0%B8%AD%E0%B8%B4%E0%B8%87\">อ้างอิง <a href=\"#%E0%B8%AD%E0%B9%89%E0%B8%B2%E0%B8%87%E0%B8%AD%E0%B8%B4%E0%B8%87\">#</a></h3><ul><li><a href=\"https://wiki.debian.org/OpenVPN\" target=\"_blank\" rel=\"noopener\">Debian OpenVPN guide</a></li><li><a href=\"http://code.mixpanel.com/2010/09/08/openvpn-in-the-rackspace-cloud/\">Mixpanel Engineer: Secure your codebase: OpenVPN in the (Rackspace) Cloud</a></li><li><a href=\"https://www.digitalocean.com/community/tutorials/how-to-setup-and-configure-an-openvpn-server-on-debian-6\" target=\"_blank\" rel=\"noopener\">Digital Ocean: How to Setup and Configure an OpenVPN Server on Debian 6</a></li><li><a href=\"https://support.cyberghostvpn.com/index.php?/Knowledgebase/Article/View/667/184/cyberghost-with-openvpn-on-flashed-dd-wrt-routers\" target=\"_blank\" rel=\"noopener\">CyberGhost with OpenVPN on flashed DD-WRT routers</a></li><li><a href=\"https://forums.openvpn.net/topic10290.html\" target=\"_blank\" rel=\"noopener\">Install help needed on centOS 6</a></li><li><a href=\"https://github.com/OpenVPN/easy-rsa\" target=\"_blank\" rel=\"noopener\">Easy-VPN github</a></li></ul></div></div>","author":"","siteTitle":"@llun story","siteHash":"e492a4c5a091b6624e5872d8d003bc73eb1166cc8f88db58c44e1f8dfb9c7252","entryHash":"a360b20fead766528314e706f4cfcff62f60ea7d93b7ebb90079b0340e649bb8","category":"Me"}