{"title":"q.js and Mocha","link":"https://www.llun.me/posts/dev/2013-11-10-qjs-mocha/","date":1384041600000,"content":"<div id=\"readability-page-1\" class=\"page\"><div><p>ปัญหาที่น่าปวดหัวอย่างหนึ่งเวลาเขียน spec คู่กับ <a href=\"https://github.com/kriskowal/q\" target=\"_blank\" rel=\"noopener\">q.js</a> คือ q.js จัดการ exception ให้เวลา expect แล้ว fail, exception ที่ throw จาก spec เลยไม่ถูกส่งออกมาถึง spec กลายเป็นว่า spec นั้นผ่านเพราะไม่มี error อะไร หรือถ้าเป็น async เวลาเรียก done ใน q ก็เหมือนมีตัวแปรชื่อเดียวกันอีก กลายเป็นว่า done ของ spec ไม่ถูกเรียกไปเรียกของ q แทน ตัวอย่าง spec ง่ายๆ เช่น</p><pre><code><span>function</span> <span>authenticate</span><span>(</span><span>req<span>,</span> res</span><span>)</span> <span>{</span><br>  q<span>.</span><span>nfcall</span><span>(</span>user<span>.</span>authenticate<span>,</span> req<span>.</span>body<span>.</span>username<span>,</span> req<span>.</span>body<span>.</span>password<span>)</span><br>    <span>.</span><span>then</span><span>(</span><span>function</span> <span>(</span><span>result</span><span>)</span> <span>{</span><br>      res<span>.</span><span>json</span><span>(</span>result<span>)</span><br>    <span>}</span><span>)</span><br>    <span>.</span><span>fail</span><span>(</span><span>function</span> <span>(</span><span>err</span><span>)</span> <span>{</span><br>      res<span>.</span><span>json</span><span>(</span>err<span>)</span><br>    <span>}</span><span>)</span><br><span>}</span></code></pre><p>เวลาเขียน spec อย่างง่ายๆ ที่คาดหวังคือ</p><pre><code><span>describe</span><span>(</span><span>'#authenticate'</span><span>,</span> <span>function</span> <span>(</span><span>)</span> <span>{</span><br>  <span>it</span><span>(</span><span>'should return error when password is wrong'</span><span>,</span> <span>function</span> <span>(</span><span>done</span><span>)</span> <span>{</span><br>    <span>authenticate</span><span>(</span><br>      <span>{</span> username<span>:</span> <span>'username'</span><span>,</span> password<span>:</span> <span>'wrongpassword'</span> <span>}</span><span>,</span><br>      <span>{</span><br>        <span>json</span><span>:</span> <span>function</span> <span>json</span><span>(</span><span>status<span>,</span> data</span><span>)</span> <span>{</span><br>          <span>expect</span><span>(</span>output<span>.</span>status<span>)</span><span>.</span>to<span>.</span><span>equal</span><span>(</span><span>200</span><span>)</span><br>          <span>expect</span><span>(</span>output<span>.</span>data<span>.</span>message<span>)</span><span>.</span>to<span>.</span><span>equal</span><span>(</span><span>'Wrong password'</span><span>)</span><br>          <span>done</span><span>(</span><span>)</span><br>        <span>}</span><br>      <span>}</span><br>    <span>)</span><br>  <span>}</span><span>)</span><br><span>}</span><span>)</span></code></pre><p>ซึ่งควรจะรันแบบผ่านไปได้ด้วยดี ถ้ามี error ก็แสดงออกมาแต่หลังจากรัน mocha จะ error เพราะ timeout (done ไม่ถูกเรียก) ทางแก้ง่ายสุดคือใช้ flag เข้าช่วยแล้วให้ interval คอยตรวจว่า flag เปลี่ยนไปหรือยังได้ออกมาเป็น specs version 2 (ใน test_it หรือ jasmine ใช้ waitFor ได้)</p><pre><code><span>describe</span><span>(</span><span>'#authenticate'</span><span>,</span> <span>function</span> <span>(</span><span>)</span> <span>{</span><br>  <span>it</span><span>(</span><span>'should return error when password is wrong'</span><span>,</span> <span>function</span> <span>(</span><span>done</span><span>)</span> <span>{</span><br>    <span>var</span> flag <span>=</span> <span>false</span><br>    <span>var</span> output <span>=</span> <span>{</span><span>}</span><p>    <span>authenticate</span><span>(</span><br>      <span>{</span> username<span>:</span> <span>'username'</span><span>,</span> password<span>:</span> <span>'wrongpassword'</span> <span>}</span><span>,</span><br>      <span>{</span><br>        <span>json</span><span>:</span> <span>function</span> <span>(</span><span>status<span>,</span> data</span><span>)</span> <span>{</span><br>          flag <span>=</span> <span>true</span><br>          output<span>.</span>status <span>=</span> status<br>          output<span>.</span>data <span>=</span> data<br>        <span>}</span><br>      <span>}</span><br>    <span>)</span></p><p>    <span>var</span> interval <span>=</span> <span>setInterval</span><span>(</span><span>function</span> <span>(</span><span>)</span> <span>{</span><br>      <span>if</span> <span>(</span><span>!</span>flag<span>)</span> <span>return</span></p><p>      <span>clearInterval</span><span>(</span>interval<span>)</span><br>      <span>expect</span><span>(</span>output<span>.</span>status<span>)</span><span>.</span>to<span>.</span><span>equal</span><span>(</span><span>200</span><span>)</span><br>      <span>expect</span><span>(</span>output<span>.</span>data<span>.</span>message<span>)</span><span>.</span>to<span>.</span><span>equal</span><span>(</span><span>'Wrong password'</span><span>)</span><br>      <span>done</span><span>(</span><span>)</span><br>    <span>}</span><span>,</span> <span>100</span><span>)</span><br>  <span>}</span><span>)</span><br><span>}</span><span>)</span></p></code></pre><p>ซึ่งหน้าตายาวเหยียดและดูไม่น่าเขียนเท่าไหร่ เลยหาทางกำจัด flag กับ setInterval ก่อนออกมาเป็น version 3</p><pre><code><span>describe</span><span>(</span><span>'#authenticate'</span><span>,</span> <span>function</span> <span>(</span><span>)</span> <span>{</span><br>  <span>it</span><span>(</span><span>'should return error when password is wrong'</span><span>,</span> <span>function</span> <span>(</span><span>done</span><span>)</span> <span>{</span><br>    <span>var</span> deferred <span>=</span> q<span>.</span><span>defer</span><span>(</span><span>)</span><br>    <span>var</span> output <span>=</span> <span>null</span><p>    deferred<span>.</span>promise<span>.</span><span>then</span><span>(</span><span>function</span> <span>(</span><span>)</span> <span>{</span><br>      <span>expect</span><span>(</span>output<span>.</span>status<span>)</span><span>.</span>to<span>.</span><span>equal</span><span>(</span><span>200</span><span>)</span><br>      <span>expect</span><span>(</span>output<span>.</span>data<span>.</span>message<span>)</span><span>.</span>to<span>.</span><span>equal</span><span>(</span><span>'Wrong password'</span><span>)</span><br>      <span>done</span><span>(</span><span>)</span><br>    <span>}</span><span>)</span></p><p>    <span>authenticate</span><span>(</span><br>      <span>{</span> username<span>:</span> <span>'username'</span><span>,</span> password<span>:</span> <span>'wrongpassword'</span> <span>}</span><span>,</span><br>      <span>{</span><br>        <span>json</span><span>:</span> <span>function</span> <span>(</span><span>status<span>,</span> data</span><span>)</span> <span>{</span><br>          output<span>.</span>status <span>=</span> status<br>          output<span>.</span>data <span>=</span> data<br>          deferred<span>.</span><span>resolve</span><span>(</span><span>)</span><br>        <span>}</span><br>      <span>}</span><br>    <span>)</span><br>  <span>}</span><span>)</span><br><span>}</span><span>)</span></p></code></pre><p>สิ่งที่ยังกวนใจอยู่คือ output ที่มันควรส่งเข้าไปให้ test ตรงๆ ได้ไม่ต้องมาสร้าง variable รับอีกเลยใช้ spread ช่วย</p><pre><code><span>describe</span><span>(</span><span>'#authenticate'</span><span>,</span> <span>function</span> <span>(</span><span>)</span> <span>{</span><br>  <span>it</span><span>(</span><span>'should return error when password is wrong'</span><span>,</span> <span>function</span> <span>(</span><span>done</span><span>)</span> <span>{</span><br>    <span>var</span> deferred <span>=</span> q<span>.</span><span>defer</span><span>(</span><span>)</span><p>    deferred<span>.</span>promise<span>.</span><span>spread</span><span>(</span><span>function</span> <span>(</span><span>status<span>,</span> data</span><span>)</span> <span>{</span><br>      <span>expect</span><span>(</span>status<span>)</span><span>.</span>to<span>.</span><span>equal</span><span>(</span><span>200</span><span>)</span><br>      <span>expect</span><span>(</span>data<span>.</span>message<span>)</span><span>.</span>to<span>.</span><span>equal</span><span>(</span><span>'Wrong password'</span><span>)</span><br>      <span>done</span><span>(</span><span>)</span><br>    <span>}</span><span>)</span></p><p>    <span>authenticate</span><span>(</span><br>      <span>{</span> username<span>:</span> <span>'username'</span><span>,</span> password<span>:</span> <span>'wrongpassword'</span> <span>}</span><span>,</span><br>      <span>{</span><br>        <span>json</span><span>:</span> <span>function</span> <span>(</span><span>status<span>,</span> data</span><span>)</span> <span>{</span><br>          deferred<span>.</span><span>resolve</span><span>(</span><span>[</span>status<span>,</span> data<span>]</span><span>)</span><br>        <span>}</span><br>      <span>}</span><br>    <span>)</span><br>  <span>}</span><span>)</span><br><span>}</span><span>)</span></p></code></pre><p>นี่แหละที่ต้องการมี code เพิ่มนิดหน่อยเกือบจะเท่าแบบแรกสุดแถมดูดีอีกต่างหาก ไม่มีตัวแปรอื่นมากวนเท่าไหร่ เขียนมานี่ตอนลองมั่วอยู่นานกว่าจะได้ แต่ก่อนใช้ mocha-as-promise ช่วยแต่พบว่ามันดันให้ผ่านใน test ที่ควรจะ fail เลยเลิกใช้เลย</p></div></div>","author":"","siteTitle":"@llun story","siteHash":"e492a4c5a091b6624e5872d8d003bc73eb1166cc8f88db58c44e1f8dfb9c7252","entryHash":"07d59c702130635d8c2e3ac6299712d2a548d7a0da1219df747cc10b9b5b455a","category":"Me"}